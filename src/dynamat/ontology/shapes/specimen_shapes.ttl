@prefix dyn: <https://dynamat.utep.edu/ontology#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

# =============================================================================
# DynaMat Platform - Specimen SHACL Shapes
# =============================================================================
#
# VALIDATION PHILOSOPHY:
# - GUI handles: data types, basic ranges, required field indicators
# - SHACL handles: business rules, patterns, cross-property constraints
#
# This file contains ONLY validation that cannot be done at the GUI level:
# 1. Required fields (minCount)
# 2. Pattern matching (ID formats)
# 3. Cardinality constraints (maxCount for single-value properties)
# 4. Cross-property business rules (conditional constraints)
# 5. Data consistency rules (dimensional logic, parameter applicability)
#
# Simple validations (data types, positive numbers) are handled by widgets.
# =============================================================================

#################################################################
#    Core Specimen Shape
#################################################################

dyn:SpecimenShape a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    rdfs:comment "Core validation rules for specimen instances" ;

    # =========================================================================
    # REQUIRED FIELDS (Critical - must be present)
    # =========================================================================

    sh:property [
        sh:path dyn:hasSpecimenID ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:pattern "^DYNML-[A-Z0-9]+-[0-9]{4}$" ;
        sh:message "Specimen ID is required and must follow format: DYNML-<MaterialCode>-<4digits> (e.g., DYNML-AL6061-0001)" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasMaterial ;
        sh:nodeKind sh:IRI ;  # Must be a URI reference (not sh:class to allow subclasses)
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Material is required and must be a valid material reference" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasSpecimenRole ;
        sh:nodeKind sh:IRI ;  # Must be a URI reference (not sh:class to allow subclasses)
        sh:minCount 1 ;
        sh:message "Specimen role is required (e.g., TestSpecimen, CharacterizationSpecimen)" ;
        sh:severity sh:Violation ;
    ] ;

    # =========================================================================
    # CARDINALITY CONSTRAINTS (Ensure single-value properties)
    # =========================================================================
    # Only enforce maxCount=1 for properties that should be single-valued
    # GUI widgets enforce this, but SHACL provides schema-level guarantee

    # Object Properties
    sh:property [ sh:path dyn:hasCompositePhaseDescription ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasStructure ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeType ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasShape ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasSpecimenBatchID ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasCharacterizationGroupID ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasHeatTreatment ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasSurfaceFinish ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasBuildOrientation ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasPolishingCompound ; sh:maxCount 1 ] ;

    # Data Properties - Identification
    sh:property [ sh:path dyn:isCharacterizationRepresentative ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ;

    # Data Properties - Dimensions (measurements)
    # Note: No min/max value constraints - GUI widgets handle range validation
    sh:property [ sh:path dyn:hasOriginalLength ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasOriginalGaugeLength ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasOriginalWidth ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasOriginalHeight ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasOriginalThickness ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasOriginalDiameter ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasOriginalCrossSection ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasOriginalMass ; sh:maxCount 1 ] ;

    sh:property [ sh:path dyn:hasFinalLength ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasFinalGaugeLength ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasFinalWidth ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasFinalHeight ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasFinalThickness ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasFinalDiameter ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasFinalCrossSection ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasFinalMass ; sh:maxCount 1 ] ;

    # Data Properties - Manufacturing
    sh:property [ sh:path dyn:hasManufacturedDate ; sh:maxCount 1 ; sh:datatype xsd:date ] ;

    # Data Properties - Processing Parameters
    sh:property [ sh:path dyn:hasBuildAngle ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLayerThickness ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasMachiningTolerance ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasMetalTemperature ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasMoldTemperature ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasCastCoolingDuration ; sh:maxCount 1 ] ;

    # Data Properties - Heat Treatment
    sh:property [ sh:path dyn:hasHeatTreatmentTemperature ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasHeatTreatmentDuration ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasCoolingTime ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasCoolingRate ; sh:maxCount 1 ] ;

    # Data Properties - Surface Finish
    sh:property [ sh:path dyn:hasFinalGritSize ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasSurfaceRoughness ; sh:maxCount 1 ] ;

    # Data Properties - Lattice Structure
    sh:property [ sh:path dyn:hasLatticeCellsX ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeCellsY ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeCellsZ ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasVoxelSize ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeNodeRadius ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeStrutMinX ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeStrutMaxX ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeStrutMinY ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeStrutMaxY ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeStrutMinZ ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeStrutMaxZ ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeNx ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeNy ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeNz ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasLatticeRingThickness ; sh:maxCount 1 ] .


#################################################################
#    Business Rules - Complex Validation Constraints
#################################################################

# -----------------------------------------------------------------------------
# Unique Specimen ID Constraint
# -----------------------------------------------------------------------------
dyn:UniqueSpecimenIDConstraint a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Specimen ID must be unique - a specimen with ID '{?id}' already exists" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasSpecimenID ?id .
                ?other dyn:hasSpecimenID ?id .
                FILTER(?this != ?other)
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Build Angle Constraint (only for custom orientation)
# -----------------------------------------------------------------------------
dyn:BuildAngleConstraint a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Build angle should only be specified when build orientation is 'Custom' - for standard orientations, use predefined values" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Build angle should only be present when build orientation is CustomAngle
            SELECT ?this WHERE {
                ?this dyn:hasBuildAngle ?angle .
                FILTER NOT EXISTS { ?this dyn:hasBuildOrientation dyn:CustomAngle }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Shape Requirement for Test/Calibration Specimens
# -----------------------------------------------------------------------------
dyn:TestSpecimenShapeRequirement a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Test and calibration specimens must have a shape specified (e.g., Cylindrical, Cubic, or Dogbone)" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Test and calibration specimens require a shape to be specified
            SELECT ?this WHERE {
                {
                    ?this dyn:hasSpecimenRole dyn:TestSpecimen .
                } UNION {
                    ?this dyn:hasSpecimenRole dyn:CalibrationSpecimen .
                }
                FILTER NOT EXISTS { ?this dyn:hasShape ?shape }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Strut Thickness Constraint (max >= min)
# -----------------------------------------------------------------------------
dyn:StrutThicknessConstraint a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Maximum strut thickness must be greater than or equal to minimum strut thickness in each direction" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                {
                    ?this dyn:hasLatticeStrutMinX ?minX .
                    ?this dyn:hasLatticeStrutMaxX ?maxX .
                    FILTER(?maxX < ?minX)
                } UNION {
                    ?this dyn:hasLatticeStrutMinY ?minY .
                    ?this dyn:hasLatticeStrutMaxY ?maxY .
                    FILTER(?maxY < ?minY)
                } UNION {
                    ?this dyn:hasLatticeStrutMinZ ?minZ .
                    ?this dyn:hasLatticeStrutMaxZ ?maxZ .
                    FILTER(?maxZ < ?minZ)
                }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Dimensional Consistency - Cylindrical Specimens (REQUIRED - Validation)
# -----------------------------------------------------------------------------
dyn:CylindricalSpecimenConstraint a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Cylindrical specimens require diameter and height. Width, length, thickness, and gauge length should not be specified." ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Cylindrical specimens must have diameter and height, and must not have width, length, thickness, or gauge length
            SELECT ?this WHERE {
                ?this dyn:hasShape dyn:CylindricalShape .
                {
                    # Missing required dimensions
                    FILTER NOT EXISTS { ?this dyn:hasOriginalDiameter ?diameter }
                } UNION {
                    FILTER NOT EXISTS { ?this dyn:hasOriginalHeight ?height }
                } UNION {
                    # Has forbidden dimensions
                    ?this dyn:hasOriginalWidth ?width .
                } UNION {
                    ?this dyn:hasOriginalLength ?length .
                } UNION {
                    ?this dyn:hasOriginalThickness ?thickness .
                } UNION {
                    ?this dyn:hasOriginalGaugeLength ?gaugeLength .
                }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Dimensional Consistency - Cubic Specimens (REQUIRED - Validation)
# -----------------------------------------------------------------------------
dyn:CubicSpecimenConstraint a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Cubic specimens require length (cube side). Diameter, width, height, thickness, and gauge length should not be specified." ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Cubic specimens must have length (cube side), and must not have diameter, width, height, thickness, or gauge length
            SELECT ?this WHERE {
                ?this dyn:hasShape dyn:CubicShape .
                {
                    # Missing required dimension
                    FILTER NOT EXISTS { ?this dyn:hasOriginalLength ?length }
                } UNION {
                    # Has forbidden dimensions
                    ?this dyn:hasOriginalDiameter ?diameter .
                } UNION {
                    ?this dyn:hasOriginalWidth ?width .
                } UNION {
                    ?this dyn:hasOriginalHeight ?height .
                } UNION {
                    ?this dyn:hasOriginalThickness ?thickness .
                } UNION {
                    ?this dyn:hasOriginalGaugeLength ?gaugeLength .
                }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Dimensional Consistency - Dogbone Specimens (REQUIRED - Validation)
# -----------------------------------------------------------------------------
dyn:DogboneSpecimenConstraint a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Dogbone specimens require length, gauge length, width, and thickness. Diameter and height should not be specified." ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Dogbone specimens must have length, gauge length, width, and thickness; diameter and height should not be specified
            SELECT ?this WHERE {
                ?this dyn:hasShape dyn:DogboneShape .
                {
                    # Missing required dimensions
                    FILTER NOT EXISTS { ?this dyn:hasOriginalLength ?length }
                } UNION {
                    FILTER NOT EXISTS { ?this dyn:hasOriginalGaugeLength ?gaugeLength }
                } UNION {
                    FILTER NOT EXISTS { ?this dyn:hasOriginalWidth ?width }
                } UNION {
                    FILTER NOT EXISTS { ?this dyn:hasOriginalThickness ?thickness }
                } UNION {
                    # Has forbidden dimensions
                    ?this dyn:hasOriginalDiameter ?diameter .
                } UNION {
                    ?this dyn:hasOriginalHeight ?height .
                }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Lattice Properties Constraint (only for lattice structures)
# -----------------------------------------------------------------------------
dyn:LatticePropertiesConstraint a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Lattice properties should only be specified for specimens with lattice structure" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Lattice properties should only exist when structure is LatticeStructure
            SELECT ?this WHERE {
                FILTER NOT EXISTS { ?this dyn:hasStructure dyn:LatticeStructure }
                {
                    ?this dyn:hasLatticeCellsX ?cellsX .
                } UNION {
                    ?this dyn:hasLatticeCellsY ?cellsY .
                } UNION {
                    ?this dyn:hasLatticeCellsZ ?cellsZ .
                } UNION {
                    ?this dyn:hasVoxelSize ?voxelSize .
                } UNION {
                    ?this dyn:hasLatticeNodeRadius ?nodeRadius .
                } UNION {
                    ?this dyn:hasLatticeRingThickness ?ringThickness .
                } UNION {
                    ?this dyn:hasLatticeType ?latticeType .
                }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Lattice Type Required (for lattice structures)
# -----------------------------------------------------------------------------
dyn:LatticeTypeRequired a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Lattice structures require a lattice type to be specified (e.g., Gyroid, Simple Cubic)" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Specimens with lattice structure must have a lattice type specified
            SELECT ?this WHERE {
                ?this dyn:hasStructure dyn:LatticeStructure .
                FILTER NOT EXISTS { ?this dyn:hasLatticeType ?latticeType }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Heat Treatment Parameters Constraint
# -----------------------------------------------------------------------------
dyn:HeatTreatmentParametersConstraint a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Heat treatment parameters should only be specified when a heat treatment type is selected" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Heat treatment parameters should only exist when hasHeatTreatment is specified
            SELECT ?this WHERE {
                FILTER NOT EXISTS { ?this dyn:hasHeatTreatment ?treatment }
                {
                    ?this dyn:hasHeatTreatmentTemperature ?temp .
                } UNION {
                    ?this dyn:hasHeatTreatmentDuration ?duration .
                } UNION {
                    ?this dyn:hasCoolingTime ?coolTime .
                } UNION {
                    ?this dyn:hasCoolingRate ?coolRate .
                }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Surface Finish Parameters Constraint
# -----------------------------------------------------------------------------
dyn:SurfaceFinishParametersConstraint a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Surface finish parameters should only be specified when a surface finish type is selected" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Surface finish parameters should only exist when hasSurfaceFinish is specified
            SELECT ?this WHERE {
                FILTER NOT EXISTS { ?this dyn:hasSurfaceFinish ?finish }
                {
                    ?this dyn:hasFinalGritSize ?grit .
                } UNION {
                    ?this dyn:hasPolishingCompound ?compound .
                } UNION {
                    ?this dyn:hasSurfaceRoughness ?roughness .
                }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Additive Manufacturing Parameters Constraint
# -----------------------------------------------------------------------------
dyn:AMParametersConstraint a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Additive manufacturing parameters should only be specified when Additive Manufacturing is selected" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: AM parameters should only exist when manufacturing method is 3DPrinting
            # Only warn if at least one manufacturing method is selected (not an empty form)
            SELECT ?this WHERE {
                # Has at least one manufacturing method selected
                ?this dyn:hasManufacturingMethod ?anyMethod .
                # Does NOT have 3DPrinting method
                FILTER NOT EXISTS { ?this dyn:hasManufacturingMethod dyn:3DPrinting }
                # But HAS AM parameters
                {
                    ?this dyn:hasBuildOrientation ?orientation .
                } UNION {
                    ?this dyn:hasBuildAngle ?angle .
                } UNION {
                    ?this dyn:hasLayerThickness ?layerThickness .
                }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Casting Parameters Constraint
# -----------------------------------------------------------------------------
dyn:CastingParametersConstraint a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Casting parameters should only be specified when Casting is selected as manufacturing method" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Casting parameters should only exist when manufacturing method is Casting
            # Only warn if at least one manufacturing method is selected (not an empty form)
            SELECT ?this WHERE {
                # Has at least one manufacturing method selected
                ?this dyn:hasManufacturingMethod ?anyMethod .
                # Does NOT have Casting method
                FILTER NOT EXISTS { ?this dyn:hasManufacturingMethod dyn:Casting }
                # But HAS casting parameters
                {
                    ?this dyn:hasMoltenMetalTemperature ?metalTemp .
                } UNION {
                    ?this dyn:hasMoldTemperature ?moldTemp .
                } UNION {
                    ?this dyn:hasCastCoolingDuration ?coolDuration .
                }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Machining Parameters Constraint
# -----------------------------------------------------------------------------
dyn:MachiningParametersConstraint a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Machining tolerance should only be specified when Machining is selected as manufacturing method" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Machining tolerance should only exist when manufacturing method is Machining
            # Only warn if at least one manufacturing method is selected (not an empty form)
            SELECT ?this WHERE {
                # Has at least one manufacturing method selected
                ?this dyn:hasManufacturingMethod ?anyMethod .
                # Has machining tolerance
                ?this dyn:hasMachiningTolerance ?tolerance .
                # Does NOT have Machining method
                FILTER NOT EXISTS { ?this dyn:hasManufacturingMethod dyn:Machining }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Composite Materials Recommendation
# -----------------------------------------------------------------------------
dyn:CompositePhaseRecommendation a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Info ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Consider specifying composite phase description to document matrix, reinforcement, and volume fractions" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ] ;
            sh:declare [
                sh:prefix "rdf" ;
                sh:namespace "http://www.w3.org/1999/02/22-rdf-syntax-ns#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Specimens with composite materials should have phase descriptions to document matrix/reinforcement details
            SELECT ?this WHERE {
                ?this dyn:hasMaterial ?material .
                ?material rdf:type dyn:Composite .
                FILTER NOT EXISTS { ?this dyn:hasCompositePhaseDescription ?desc }
            }
        """ ;
    ] .

#################################################################
#    Metadata Tracking Constraints
#################################################################

# -----------------------------------------------------------------------------
# Creation Metadata Required (Violation - Blocks Save)
# -----------------------------------------------------------------------------
dyn:CreationMetadataRequired a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Form creation must have user metadata. Please select an user to attribute this form to." ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: All specimens must have creation metadata for proper provenance tracking
            SELECT ?this WHERE {
                ?this a dyn:Specimen .
                {
                    FILTER NOT EXISTS { ?this dyn:hasCreatedBy ?creator }
                } UNION {
                    FILTER NOT EXISTS { ?this dyn:hasCreatedDate ?created }
                } UNION {
                    FILTER NOT EXISTS { ?this dyn:hasAppVersion ?version }
                }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Modification Metadata Consistency (Violation - Blocks Save)
# -----------------------------------------------------------------------------
dyn:ModificationMetadataConsistency a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "If modification metadata is present, both modified by and modified date must be specified together" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Modification metadata must be complete (both user and date) when present
            SELECT ?this WHERE {
                ?this a dyn:Specimen .
                {
                    # Has modifiedBy but not modifiedDate
                    ?this dyn:hasModifiedBy ?modifier .
                    FILTER NOT EXISTS { ?this dyn:hasModifiedDate ?modDate }
                } UNION {
                    # Has modifiedDate but not modifiedBy
                    ?this dyn:hasModifiedDate ?modDate .
                    FILTER NOT EXISTS { ?this dyn:hasModifiedBy ?modifier }
                }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Creation Metadata Immutability Warning
# -----------------------------------------------------------------------------
dyn:CreationMetadataImmutability a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Creation metadata should not be changed after initial save. Only modification metadata should be updated." ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Specimens with modification metadata should retain original creation metadata
            SELECT ?this WHERE {
                ?this a dyn:Specimen .
                ?this dyn:hasModifiedBy ?modifier .
                {
                    FILTER NOT EXISTS { ?this dyn:hasCreatedBy ?creator }
                } UNION {
                    FILTER NOT EXISTS { ?this dyn:hasCreatedDate ?created }
                }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Modified Specimen Information (Info - Display Only)
# -----------------------------------------------------------------------------
dyn:ModifiedSpecimenInfo a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Info ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "This specimen has been modified since creation. See modification metadata for details." ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Informational message for specimens that have been modified
            SELECT ?this WHERE {
                ?this a dyn:Specimen .
                ?this dyn:hasModifiedBy ?modifier .
                ?this dyn:hasModifiedDate ?modDate .
            }
        """ ;
    ] .

#################################################################
#    Post-Test Dimension Warnings (Non-Characterization Only)
#################################################################

# -----------------------------------------------------------------------------
# Cylindrical Specimens - Post-Test Dimensions Warning
# -----------------------------------------------------------------------------
dyn:CylindricalPostTestWarning a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Post-test dimensions (final diameter and height) are recommended for cylindrical test specimens. These document specimen changes after testing." ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Cylindrical test/calibration specimens should have final diameter and height to document post-test changes
            SELECT ?this WHERE {
                ?this dyn:hasShape dyn:CylindricalShape .
                { ?this dyn:hasSpecimenRole dyn:TestSpecimen . }
                UNION
                { ?this dyn:hasSpecimenRole dyn:CalibrationSpecimen . }
                {
                    FILTER NOT EXISTS { ?this dyn:hasFinalDiameter ?diameter }
                } UNION {
                    FILTER NOT EXISTS { ?this dyn:hasFinalHeight ?height }
                }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Cubic Specimens - Post-Test Dimensions Warning
# -----------------------------------------------------------------------------
dyn:CubicPostTestWarning a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Post-test dimension (final length) is recommended for cubic test specimens. This documents specimen changes after testing." ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Cubic test/calibration specimens should have final length to document post-test changes
            SELECT ?this WHERE {
                ?this dyn:hasShape dyn:CubicShape .
                { ?this dyn:hasSpecimenRole dyn:TestSpecimen . }
                UNION
                { ?this dyn:hasSpecimenRole dyn:CalibrationSpecimen . }
                FILTER NOT EXISTS { ?this dyn:hasFinalLength ?length }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Dogbone Specimens - Post-Test Dimensions Warning
# -----------------------------------------------------------------------------
dyn:DogbonePostTestWarning a sh:NodeShape ;
    sh:targetClass dyn:Specimen ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Post-test dimensions (final length, gauge length, width, and thickness) are recommended for dogbone test specimens. These document specimen changes after testing." ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            # Query description: Dogbone test/calibration specimens should have all final dimensions to document post-test changes
            SELECT ?this WHERE {
                ?this dyn:hasShape dyn:DogboneShape .
                { ?this dyn:hasSpecimenRole dyn:TestSpecimen . }
                UNION
                { ?this dyn:hasSpecimenRole dyn:CalibrationSpecimen . }
                {
                    FILTER NOT EXISTS { ?this dyn:hasFinalLength ?length }
                } UNION {
                    FILTER NOT EXISTS { ?this dyn:hasFinalGaugeLength ?gaugeLength }
                } UNION {
                    FILTER NOT EXISTS { ?this dyn:hasFinalWidth ?width }
                } UNION {
                    FILTER NOT EXISTS { ?this dyn:hasFinalThickness ?thickness }
                }
            }
        """ ;
    ] .
