@prefix dyn: <https://dynamat.utep.edu/ontology#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix qudt: <http://qudt.org/schema/qudt/> .
@prefix unit: <http://qudt.org/vocab/unit/> .
@prefix qkdv: <http://qudt.org/vocab/quantitykind/> .

# =============================================================================
# DynaMat Platform - Mechanical Testing SHACL Shapes
# =============================================================================
#
# VALIDATION PHILOSOPHY:
# - GUI handles: data types, basic ranges, required field indicators
# - SHACL handles: business rules, patterns, cross-property constraints
#
# This file validates mechanical testing data including:
# 1. MechanicalTest (base class)
# 2. SHPBCompression (SHPB-specific test data)
# 3. DataSeries (RawSignal, ProcessedData)
# 4. AnalysisFile (CSV metadata)
# 5. Processing instances (PulseWindow, PulseShift, PulseDetectionParams, etc.)
#
# Simple validations (data types, positive numbers) are handled by widgets.
# =============================================================================

#################################################################
#    MechanicalTest Shape (Base Class)
#################################################################

dyn:MechanicalTestShape a sh:NodeShape ;
    sh:targetClass dyn:MechanicalTest ;
    rdfs:comment "Core validation rules for all mechanical test instances" ;

    # =========================================================================
    # REQUIRED FIELDS (Critical - must be present)
    # =========================================================================

    sh:property [
        sh:path dyn:hasTestID ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "Test ID is required" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:performedOn ;
        sh:class dyn:Specimen ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Test must be performed on a specimen" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasTestDate ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:date ;
        sh:message "Test date is required" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasUser ;
        sh:class dyn:User ;
        sh:minCount 1 ;
        sh:message "At least one operator must be assigned to the test" ;
        sh:severity sh:Violation ;
    ] ;

    # =========================================================================
    # CARDINALITY CONSTRAINTS (Single-value properties)
    # =========================================================================

    sh:property [ sh:path dyn:hasTestType ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasTestTemperature ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasHeatingRate ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasTemperatureStabilizationTime ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasLoadFrame ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasSamplingRate ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDataAcquisitionSystem ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasFilterFrequency ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDeformationMode ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasFailureMode ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasTestValidity ; sh:maxCount 1 ; sh:datatype xsd:string ] ;

    # Strain gauge configuration
    sh:property [ sh:path dyn:hasCalibrationResistance ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasCalibrationVoltage ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDataBitResolution ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasDataTriggerDuration ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasCompressionSign ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasGaugeFactor ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasGaugeResistance ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasGaugeVoltageInputRange ; sh:maxCount 1 ; sh:datatype xsd:double ] .


#################################################################
#    SHPBCompression Shape (SHPB-specific properties)
#################################################################

dyn:SHPBCompressionShape a sh:NodeShape ;
    sh:targetClass dyn:SHPBCompression ;
    rdfs:comment "Validation rules for SHPB compression test instances" ;

    # =========================================================================
    # CARDINALITY CONSTRAINTS (Single-value properties)
    # =========================================================================

    # Equipment configuration
    sh:property [ sh:path dyn:hasStrikerBar ; sh:maxCount 1 ; sh:class dyn:Bar ] ;
    sh:property [ sh:path dyn:hasIncidentBar ; sh:maxCount 1 ; sh:class dyn:Bar ] ;
    sh:property [ sh:path dyn:hasTransmissionBar ; sh:maxCount 1 ; sh:class dyn:Bar ] ;
    sh:property [ sh:path dyn:hasMomentumTrap ; sh:maxCount 1 ; sh:class dyn:MomentumTrap ] ;
    sh:property [ sh:path dyn:hasPulseShaper ; sh:maxCount 1 ; sh:class dyn:PulseShaper ] ;

    # Test conditions
    sh:property [ sh:path dyn:hasStrikerVelocity ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasStrikerLength ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasIncidentBarLength ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasTransmissionBarLength ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasBarrelOffset ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasIncidentStrainGaugeDistance ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasTransmissionStrainGaugeDistance ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasLubricationUsed ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ;
    sh:property [ sh:path dyn:hasLubricationType ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasMomentumTrapTailoredDistance ; sh:maxCount 1 ; sh:datatype xsd:double ] ;

    # Pulse shaping
    sh:property [ sh:path dyn:hasPulseShaping ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ;
    sh:property [ sh:path dyn:hasPulseShaperDiameter ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasPulseShaperThickness ; sh:maxCount 1 ; sh:datatype xsd:double ] ;

    # Pulse characteristics
    sh:property [ sh:path dyn:hasPulseDuration ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasPulseLength ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasPulseSpeed ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasPulseStrainAmplitude ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasPulseStressAmplitude ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasPulseRiseTime ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasPulsePoints ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;

    # Processing parameters
    sh:property [ sh:path dyn:hasAlignmentParams ; sh:maxCount 1 ; sh:class dyn:AlignmentParams ] ;
    sh:property [ sh:path dyn:hasEquilibriumMetrics ; sh:maxCount 1 ; sh:class dyn:EquilibriumMetrics ] ;
    sh:property [ sh:path dyn:hasAppliedShift ; sh:maxCount 1 ; sh:class dyn:PulseShift ] ;
    sh:property [ sh:path dyn:hasDetectedWindow ; sh:maxCount 1 ; sh:class dyn:PulseWindow ] ;

    # Analysis metadata
    sh:property [ sh:path dyn:hasAnalysisTimestamp ; sh:maxCount 1 ; sh:datatype xsd:date ] ;
    sh:property [ sh:path dyn:hasCenteredSegmentPoints ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasSamplingInterval ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasTukeyAlpha ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasThresholdRatio ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasShiftValue ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasSelectionMetric ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasKLinear ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasKTrials ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasMinSeparation ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasFrontIndex ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasDetectionLowerBound ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasDetectionUpperBound ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasDetectionPolarity ; sh:maxCount 1 ; sh:datatype xsd:string ] ;

    # Equilibrium metrics (stored at test level)
    sh:property [ sh:path dyn:hasDSUF ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasFBC ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasSEQI ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasSOI ; sh:maxCount 1 ; sh:datatype xsd:double ] ;

    # Note: Data file references removed - files are linked via DataSeries (hasDataFile)

    # Qualitative assessment
    sh:property [ sh:path dyn:hasWaveDispersion ; sh:maxCount 1 ; sh:datatype xsd:string ] .


#################################################################
#    DataSeries Shape (Base for all data series)
#################################################################

dyn:DataSeriesShape a sh:NodeShape ;
    sh:targetClass dyn:DataSeries ;
    rdfs:comment "Base validation rules for data series instances" ;

    # =========================================================================
    # REQUIRED FIELDS
    # =========================================================================

    sh:property [
        sh:path dyn:hasSeriesType ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "Data series must have a series type (Stress, Strain, Time, etc.)" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasDataFile ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class dyn:AnalysisFile ;
        sh:message "Data series must reference a data file" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasColumnName ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "Data series must specify column name in data file" ;
        sh:severity sh:Violation ;
    ] ;

    # =========================================================================
    # CARDINALITY CONSTRAINTS
    # =========================================================================

    sh:property [ sh:path dyn:hasColumnIndex ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasLegendName ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasAnalysisMethod ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasSeriesUnit ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasQuantityKind ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasDataPointCount ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasProcessingMethod ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasFilterApplied ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ;
    sh:property [ sh:path dyn:hasFilterType ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasFilterFrequency ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasTukeyAlpha ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasTukeyWindowLength ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasSamplingInterval ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:isCenteredPulse ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ;
    sh:property [ sh:path dyn:isAlignedPulse ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ;
    sh:property [ sh:path dyn:isReferencePulse ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ;
    sh:property [ sh:path dyn:hasSegmentShift ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasThresholdRatio ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:isTrainingData ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ;
    sh:property [ sh:path dyn:measuredBy ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:derivedFrom ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasDetectedWindow ; sh:maxCount 1 ; sh:class dyn:PulseWindow ] ;
    sh:property [ sh:path dyn:hasAppliedShift ; sh:maxCount 1 ; sh:class dyn:PulseShift ] .


#################################################################
#    RawSignal Shape (Raw sensor data)
#################################################################

dyn:RawSignalShape a sh:NodeShape ;
    sh:targetClass dyn:RawSignal ;
    rdfs:comment "Validation rules for raw signal data series" ;

    # Raw signals typically have voltage as quantity kind
    sh:property [
        sh:path dyn:hasQuantityKind ;
        sh:message "Raw signals should specify quantity kind (typically Voltage or Time)" ;
        sh:severity sh:Warning ;
    ] .


#################################################################
#    ProcessedData Shape (Calculated quantities)
#################################################################

dyn:ProcessedDataShape a sh:NodeShape ;
    sh:targetClass dyn:ProcessedData ;
    rdfs:comment "Validation rules for processed data series" ;

    # Processed data should specify analysis method
    sh:property [
        sh:path dyn:hasAnalysisMethod ;
        sh:message "Processed data should specify analysis method (1-wave, 3-wave, etc.)" ;
        sh:severity sh:Warning ;
    ] ;

    # Processed data should be derived from raw data
    sh:property [
        sh:path dyn:derivedFrom ;
        sh:message "Processed data should reference source raw data series" ;
        sh:severity sh:Info ;
    ] .


#################################################################
#    AnalysisFile Shape (CSV and other data files)
#################################################################

dyn:AnalysisFileShape a sh:NodeShape ;
    sh:targetClass dyn:AnalysisFile ;
    rdfs:comment "Validation rules for analysis file metadata" ;

    # =========================================================================
    # REQUIRED FIELDS
    # =========================================================================

    sh:property [
        sh:path dyn:hasFilePath ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "Analysis file must have a file path" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasFileFormat ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "Analysis file must specify format (CSV, HDF5, etc.)" ;
        sh:severity sh:Violation ;
    ] ;

    # =========================================================================
    # CARDINALITY CONSTRAINTS
    # =========================================================================

    sh:property [ sh:path dyn:hasFileName ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasFileSize ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasDataPointCount ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasColumnCount ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasCreatedDate ; sh:maxCount 1 ; sh:datatype xsd:date ] ;
    sh:property [ sh:path dyn:hasFileEncoding ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasProcessingDate ; sh:maxCount 1 ; sh:datatype xsd:dateTime ] ;
    sh:property [ sh:path dyn:hasDelimiter ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasHeaderRow ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ;
    sh:property [ sh:path dyn:hasSkipRows ; sh:maxCount 1 ; sh:datatype xsd:integer ] .


#################################################################
#    PulseWindow Shape (Pulse detection windows)
#################################################################

dyn:PulseWindowShape a sh:NodeShape ;
    sh:targetClass dyn:PulseWindow ;
    rdfs:comment "Validation rules for pulse window instances" ;

    # =========================================================================
    # REQUIRED FIELDS
    # =========================================================================

    sh:property [
        sh:path dyn:appliedToSeries ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class dyn:DataSeries ;
        sh:message "Pulse window must reference the data series it was applied to" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasStartIndex ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:message "Pulse window must have a start index" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasEndIndex ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:message "Pulse window must have an end index" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasWindowLength ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:message "Pulse window must have a window length" ;
        sh:severity sh:Violation ;
    ] .


#################################################################
#    PulseShift Shape (Pulse alignment shifts)
#################################################################

dyn:PulseShiftShape a sh:NodeShape ;
    sh:targetClass dyn:PulseShift ;
    rdfs:comment "Validation rules for pulse shift instances" ;

    # =========================================================================
    # REQUIRED FIELDS
    # =========================================================================

    sh:property [
        sh:path dyn:appliedToSeries ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class dyn:DataSeries ;
        sh:message "Pulse shift must reference the data series it was applied to" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasShiftValue ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:message "Pulse shift must have a shift value (samples)" ;
        sh:severity sh:Violation ;
    ] .


#################################################################
#    PulseDetectionParams Shape (Pulse detection configuration)
#################################################################

dyn:PulseDetectionParamsShape a sh:NodeShape ;
    sh:targetClass dyn:PulseDetectionParams ;
    rdfs:comment "Validation rules for pulse detection parameter instances" ;

    # =========================================================================
    # REQUIRED FIELDS
    # =========================================================================

    sh:property [
        sh:path dyn:appliedToSeries ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class dyn:DataSeries ;
        sh:message "Pulse detection params must reference the data series they were applied to" ;
        sh:severity sh:Violation ;
    ] ;

    # =========================================================================
    # CARDINALITY CONSTRAINTS
    # =========================================================================

    sh:property [ sh:path dyn:hasDetectionLowerBound ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasDetectionUpperBound ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasDetectionPolarity ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasKTrials ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasMinSeparation ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasPulsePoints ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasSelectionMetric ; sh:maxCount 1 ; sh:datatype xsd:string ] .


#################################################################
#    AlignmentParams Shape (Pulse alignment configuration)
#################################################################

dyn:AlignmentParamsShape a sh:NodeShape ;
    sh:targetClass dyn:AlignmentParams ;
    rdfs:comment "Validation rules for alignment parameter instances" ;

    # =========================================================================
    # CARDINALITY CONSTRAINTS
    # =========================================================================

    sh:property [ sh:path dyn:hasKLinear ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasReflectedSearchMin ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasReflectedSearchMax ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasTransmittedSearchMin ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasTransmittedSearchMax ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasCorrelationWeight ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDisplacementWeight ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasStrainRateWeight ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasStrainWeight ; sh:maxCount 1 ; sh:datatype xsd:double ] .


#################################################################
#    EquilibriumMetrics Shape (Force equilibrium assessment)
#################################################################

dyn:EquilibriumMetricsShape a sh:NodeShape ;
    sh:targetClass dyn:EquilibriumMetrics ;
    rdfs:comment "Validation rules for equilibrium metrics instances" ;

    # =========================================================================
    # CARDINALITY CONSTRAINTS
    # =========================================================================

    sh:property [ sh:path dyn:hasDSUF ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDSUFLoading ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDSUFPlateau ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDSUFUnloading ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasFBC ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasFBCLoading ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasFBCPlateau ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasFBCUnloading ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasSEQI ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasSOI ; sh:maxCount 1 ; sh:datatype xsd:double ] .


#################################################################
#    Business Rules - Complex Validation Constraints
#################################################################

# -----------------------------------------------------------------------------
# Test Date Constraint (Cannot be in future)
# -----------------------------------------------------------------------------
dyn:TestDateConstraint a sh:NodeShape ;
    sh:targetClass dyn:MechanicalTest ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Test date cannot be in the future" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasTestDate ?date .
                FILTER(?date > NOW())
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Pulse Shaper Constraint (Required when pulse shaping is used)
# -----------------------------------------------------------------------------
dyn:PulseShaperConstraint a sh:NodeShape ;
    sh:targetClass dyn:SHPBCompression ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Pulse shaper must be specified when pulse shaping is used" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasPulseShaping true .
                FILTER NOT EXISTS { ?this dyn:hasPulseShaper ?shaper }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Lubrication Type Constraint (Required when lubrication is used)
# -----------------------------------------------------------------------------
dyn:LubricationConstraint a sh:NodeShape ;
    sh:targetClass dyn:SHPBCompression ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Lubrication type must be specified when lubrication is used" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasLubricationUsed true .
                FILTER NOT EXISTS { ?this dyn:hasLubricationType ?type }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Pulse Shaper Dimension Constraint (Thickness < Diameter)
# -----------------------------------------------------------------------------
dyn:PulseShaperDimensionConstraint a sh:NodeShape ;
    sh:targetClass dyn:SHPBCompression ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Pulse shaper thickness must be less than diameter" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasPulseShaperDiameter ?diameter .
                ?this dyn:hasPulseShaperThickness ?thickness .
                FILTER(?thickness >= ?diameter)
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Pulse Window Index Constraint (End > Start)
# -----------------------------------------------------------------------------
dyn:PulseWindowIndexConstraint a sh:NodeShape ;
    sh:targetClass dyn:PulseWindow ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Pulse window end index must be greater than start index" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasStartIndex ?start .
                ?this dyn:hasEndIndex ?end .
                FILTER(?end <= ?start)
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Pulse Window Length Consistency (Length = End - Start)
# -----------------------------------------------------------------------------
dyn:PulseWindowLengthConstraint a sh:NodeShape ;
    sh:targetClass dyn:PulseWindow ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Pulse window length should equal end index minus start index" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasStartIndex ?start .
                ?this dyn:hasEndIndex ?end .
                ?this dyn:hasWindowLength ?length .
                BIND((?end - ?start) AS ?calculatedLength)
                FILTER(?length != ?calculatedLength)
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Sampling Rate Constraint (Reasonable range)
# -----------------------------------------------------------------------------
dyn:SamplingRateConstraint a sh:NodeShape ;
    sh:targetClass dyn:MechanicalTest ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Sampling rate should be between 1 Hz and 10 MHz for reasonable data acquisition" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasSamplingRate ?rate .
                FILTER(?rate < 1.0 || ?rate > 10000000.0)
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Temperature Stabilization Constraint (Required for elevated temperature)
# -----------------------------------------------------------------------------
dyn:TemperatureStabilizationConstraint a sh:NodeShape ;
    sh:targetClass dyn:MechanicalTest ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Temperature stabilization time should be specified for elevated temperature tests (≥50°C)" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasTestTemperature ?temp .
                FILTER(?temp >= 50.0)
                FILTER NOT EXISTS { ?this dyn:hasTemperatureStabilizationTime ?stabTime }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Processed Data Derivation Recommendation
# -----------------------------------------------------------------------------
dyn:ProcessedDataDerivationRecommendation a sh:NodeShape ;
    sh:targetClass dyn:ProcessedData ;
    sh:severity sh:Info ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Consider documenting source raw data series for full provenance tracking" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this a dyn:ProcessedData .
                FILTER NOT EXISTS { ?this dyn:derivedFrom ?source }
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Data Series Unit Recommendation (For quantitative measurements)
# -----------------------------------------------------------------------------
dyn:DataSeriesUnitRecommendation a sh:NodeShape ;
    sh:targetClass dyn:DataSeries ;
    sh:severity sh:Info ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Consider specifying unit and quantity kind for better semantic interoperability" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this a dyn:DataSeries .
                ?this dyn:hasSeriesType ?type .
                # Only recommend for quantitative types, not Time
                FILTER(?type IN ("Stress", "Strain", "Force", "Displacement", "StrainRate"))
                FILTER NOT EXISTS { ?this dyn:hasSeriesUnit ?unit }
            }
        """ ;
    ] .

###  Generated for DynaMat Platform mechanical testing validation
