@prefix dyn: <https://dynamat.utep.edu/ontology#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix qudt: <http://qudt.org/schema/qudt/> .
@prefix unit: <http://qudt.org/vocab/unit/> .
@prefix qkdv: <http://qudt.org/vocab/quantitykind/> .

# =============================================================================
# DynaMat Platform - Mechanical Testing SHACL Shapes (Base)
# =============================================================================
#
# VALIDATION PHILOSOPHY:
# - GUI handles: data types, basic ranges, required field indicators
# - SHACL handles: business rules, patterns, cross-property constraints
#
# This file validates the base MechanicalTest class only.
# Test-type-specific shapes are in separate files:
# - shpb_compression_shapes.ttl  (SHPB equipment, detection, alignment, etc.)
# - data_series_shapes.ttl       (DataSeries, RawSignal, ProcessedData, etc.)
#
# Simple validations (data types, positive numbers) are handled by widgets.
# =============================================================================

#################################################################
#    MechanicalTest Shape (Base Class)
#################################################################

dyn:MechanicalTestShape a sh:NodeShape ;
    sh:targetClass dyn:MechanicalTest ;
    rdfs:comment "Core validation rules for all mechanical test instances" ;

    # =========================================================================
    # REQUIRED FIELDS (Critical - must be present)
    # =========================================================================

    sh:property [
        sh:path dyn:hasTestID ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "Test ID is required" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:performedOn ;
        sh:class dyn:Specimen ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Test must be performed on a specimen" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasTestDate ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:date ;
        sh:message "Test date is required" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasUser ;
        sh:class dyn:User ;
        sh:minCount 1 ;
        sh:message "At least one operator must be assigned to the test" ;
        sh:severity sh:Violation ;
    ] ;

    # =========================================================================
    # CARDINALITY CONSTRAINTS (Single-value properties)
    # =========================================================================

    sh:property [ sh:path dyn:hasTestType ; sh:maxCount 1 ; sh:class dyn:TestType ] ;
    sh:property [ sh:path dyn:hasTestTemperature ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasHeatingRate ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasTemperatureStabilizationTime ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasLoadFrame ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasSamplingRate ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDataAcquisitionSystem ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasFilterFrequency ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDeformationMode ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasFailureMode ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasTestValidity ; sh:maxCount 1 ; sh:datatype xsd:string ] ;

    # Strain gauge configuration
    sh:property [ sh:path dyn:hasCalibrationResistance ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasCalibrationVoltage ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDataBitResolution ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasDataTriggerDuration ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasCompressionSign ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasGaugeFactor ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasGaugeResistance ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasGaugeVoltageInputRange ; sh:maxCount 1 ; sh:datatype xsd:double ] .


#################################################################
#    Business Rules - Generic Mechanical Testing Constraints
#################################################################

# -----------------------------------------------------------------------------
# Test Date Constraint (Cannot be in future)
# -----------------------------------------------------------------------------
dyn:TestDateConstraint a sh:NodeShape ;
    sh:targetClass dyn:MechanicalTest ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Test date cannot be in the future" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasTestDate ?date .
                FILTER(?date > NOW())
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Sampling Rate Constraint (Reasonable range)
# -----------------------------------------------------------------------------
dyn:SamplingRateConstraint a sh:NodeShape ;
    sh:targetClass dyn:MechanicalTest ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Sampling rate should be between 1 Hz and 10 MHz for reasonable data acquisition" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasSamplingRate ?rate .
                FILTER(?rate < 1.0 || ?rate > 10000000.0)
            }
        """ ;
    ] .

# -----------------------------------------------------------------------------
# Temperature Stabilization Constraint (Required for elevated temperature)
# -----------------------------------------------------------------------------
dyn:TemperatureStabilizationConstraint a sh:NodeShape ;
    sh:targetClass dyn:MechanicalTest ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Temperature stabilization time should be specified for elevated temperature tests (>=50C)" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasTestTemperature ?temp .
                FILTER(?temp >= 50.0)
                FILTER NOT EXISTS { ?this dyn:hasTemperatureStabilizationTime ?stabTime }
            }
        """ ;
    ] .


###  Generated for DynaMat Platform mechanical testing validation
