@prefix dyn: <https://dynamat.utep.edu/ontology#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix qudt: <http://qudt.org/schema/qudt/> .
@prefix unit: <http://qudt.org/vocab/unit/> .
@prefix qkdv: <http://qudt.org/vocab/quantitykind/> .
@prefix dc: <http://purl.org/dc/terms/> .

# =============================================================================
# DynaMat Platform - Material Class SHACL Shapes
# Based on properties defined in material_class.ttl
#
# Mechanical and physical properties now use qudt:QuantityValue range.
# Validated by dyn:QuantityValueShape (defined in qudt_shapes.ttl).
# =============================================================================

#################################################################
#    Material Shape (Base material class)
#################################################################

dyn:MaterialShape a sh:NodeShape ;
    sh:targetClass dyn:Material ;

    # Object Properties - Mechanical Properties (QuantityValue)
    sh:property [
        sh:path dyn:hasElasticModulus ;
        sh:node dyn:QuantityValueShape ;
        sh:maxCount 1 ;
        sh:name "Elastic Modulus" ;
        sh:description "Young's modulus of elasticity" ;
        sh:group "ElasticProperties" ;
        sh:order 1 ;
    ] ;

    sh:property [
        sh:path dyn:hasPoissonsRatio ;
        sh:node dyn:QuantityValueShape ;
        sh:maxCount 1 ;
        sh:name "Poisson's Ratio" ;
        sh:description "Poisson's ratio" ;
        sh:group "ElasticProperties" ;
        sh:order 2 ;
    ] ;

    sh:property [
        sh:path dyn:hasYieldStrength ;
        sh:node dyn:QuantityValueShape ;
        sh:maxCount 1 ;
        sh:name "Yield Strength" ;
        sh:description "Yield strength (Johnson-Cook A parameter)" ;
        sh:group "JohnsonCookParameters" ;
        sh:order 1 ;
    ] ;

    sh:property [
        sh:path dyn:hasHardeningConstant ;
        sh:node dyn:QuantityValueShape ;
        sh:maxCount 1 ;
        sh:name "Hardening Constant" ;
        sh:description "Hardening constant (Johnson-Cook B parameter)" ;
        sh:group "JohnsonCookParameters" ;
        sh:order 2 ;
    ] ;

    sh:property [
        sh:path dyn:hasHardeningExponent ;
        sh:node dyn:QuantityValueShape ;
        sh:maxCount 1 ;
        sh:name "Hardening Exponent" ;
        sh:description "Hardening exponent (Johnson-Cook n parameter)" ;
        sh:group "JohnsonCookParameters" ;
        sh:order 3 ;
    ] ;

    sh:property [
        sh:path dyn:hasStrainRateCoefficient ;
        sh:node dyn:QuantityValueShape ;
        sh:maxCount 1 ;
        sh:name "Strain Rate Coefficient" ;
        sh:description "Strain rate coefficient (Johnson-Cook C parameter)" ;
        sh:group "JohnsonCookParameters" ;
        sh:order 4 ;
    ] ;

    sh:property [
        sh:path dyn:hasThermalSofteningCoefficient ;
        sh:node dyn:QuantityValueShape ;
        sh:maxCount 1 ;
        sh:name "Thermal Softening Coefficient" ;
        sh:description "Thermal softening coefficient (Johnson-Cook m parameter)" ;
        sh:group "JohnsonCookParameters" ;
        sh:order 5 ;
    ] ;

    # Object Properties - Characterization and Phases
    sh:property [
        sh:path dyn:hasCharacterization ;
        sh:class dyn:CharacterizationTest ;
        sh:name "Characterization Test" ;
        sh:description "Links to characterization tests performed on specimens of this material" ;
        sh:group "Characterization" ;
        sh:order 1 ;
    ] ;

    sh:property [
        sh:path dyn:hasPhase ;
        sh:class dyn:Phase ;
        sh:name "Material Phases" ;
        sh:description "Phases present in the material" ;
        sh:group "Microstructure" ;
        sh:order 1 ;
    ] ;

    sh:property [
        sh:path dyn:hasPrimaryPhase ;
        sh:class dyn:Phase ;
        sh:maxCount 1 ;
        sh:name "Primary Phase" ;
        sh:description "Dominant phase in the material" ;
        sh:group "Microstructure" ;
        sh:order 2 ;
    ] ;

    # Data Properties - Material Identification
    sh:property [
        sh:path dyn:hasMaterialName ;
        sh:datatype xsd:string ;
        sh:maxCount 1 ;
        sh:name "Material Name" ;
        sh:description "Standard material designation (e.g., Al6061-T6, SS316L)" ;
        sh:group "Identification" ;
        sh:order 1 ;
    ] ;

    sh:property [
        sh:path dyn:hasMaterialCode ;
        sh:datatype xsd:string ;
        sh:maxCount 1 ;
        sh:name "Material Code" ;
        sh:description "Internal material identification code" ;
        sh:group "Identification" ;
        sh:order 2 ;
    ] ;

    sh:property [
        sh:path dyn:hasSupplier ;
        sh:datatype xsd:string ;
        sh:maxCount 1 ;
        sh:name "Supplier" ;
        sh:description "Material supplier or source" ;
        sh:group "Identification" ;
        sh:order 3 ;
    ] ;

    sh:property [
        sh:path dyn:hasLotNumber ;
        sh:datatype xsd:string ;
        sh:maxCount 1 ;
        sh:name "Lot Number" ;
        sh:description "Supplier lot or batch number" ;
        sh:group "Identification" ;
        sh:order 4 ;
    ] ;

    # Object Properties - Basic Physical Properties (QuantityValue)
    sh:property [
        sh:path dyn:hasDensity ;
        sh:node dyn:QuantityValueShape ;
        sh:maxCount 1 ;
        sh:name "Density" ;
        sh:description "Material density" ;
        sh:group "PhysicalProperties" ;
        sh:order 1 ;
    ] ;

    sh:property [
        sh:path dyn:hasMeltingPoint ;
        sh:node dyn:QuantityValueShape ;
        sh:maxCount 1 ;
        sh:name "Melting Point" ;
        sh:description "Melting temperature of the material" ;
        sh:group "ThermalProperties" ;
        sh:order 1 ;
    ] ;

    sh:property [
        sh:path dyn:hasThermalConductivity ;
        sh:node dyn:QuantityValueShape ;
        sh:maxCount 1 ;
        sh:name "Thermal Conductivity" ;
        sh:description "Thermal conductivity coefficient" ;
        sh:group "ThermalProperties" ;
        sh:order 2 ;
    ] ;

    sh:property [
        sh:path dyn:hasSpecificHeat ;
        sh:node dyn:QuantityValueShape ;
        sh:maxCount 1 ;
        sh:name "Specific Heat" ;
        sh:description "Specific heat capacity" ;
        sh:group "ThermalProperties" ;
        sh:order 3 ;
    ] ;

    # Data Properties - Alloy and Composition
    sh:property [
        sh:path dyn:hasAlloyDesignation ;
        sh:datatype xsd:string ;
        sh:maxCount 1 ;
        sh:name "Alloy Designation" ;
        sh:description "Standard alloy designation (e.g., 6061, 316L)" ;
        sh:group "Composition" ;
        sh:order 1 ;
    ] ;

    sh:property [
        sh:path dyn:hasTemper ;
        sh:datatype xsd:string ;
        sh:maxCount 1 ;
        sh:name "Temper Condition" ;
        sh:description "Heat treatment condition or temper" ;
        sh:group "Composition" ;
        sh:order 2 ;
    ] ;

    sh:property [
        sh:path dyn:hasChemicalComposition ;
        sh:datatype xsd:string ;
        sh:maxCount 1 ;
        sh:name "Chemical Composition" ;
        sh:description "Chemical composition description or certificate reference" ;
        sh:group "Composition" ;
        sh:order 3 ;
    ] ;

    # Data Properties - Material Source and Certification
    sh:property [
        sh:path dyn:hasCertificationLevel ;
        sh:datatype xsd:string ;
        sh:maxCount 1 ;
        sh:name "Certification Level" ;
        sh:description "Level of material certification" ;
        sh:group "Certification" ;
        sh:order 1 ;
        sh:in ("Mill Test Certificate" "ASTM Certified" "Research Grade" "Commercial Grade" "Unknown") ;
    ] ;

    sh:property [
        sh:path dyn:hasCertificateNumber ;
        sh:datatype xsd:string ;
        sh:maxCount 1 ;
        sh:name "Certificate Number" ;
        sh:description "Mill test certificate or material certificate number" ;
        sh:group "Certification" ;
        sh:order 2 ;
    ] ;

    sh:property [
        sh:path dyn:hasReceiptDate ;
        sh:datatype xsd:date ;
        sh:maxCount 1 ;
        sh:name "Receipt Date" ;
        sh:description "Date material was received" ;
        sh:group "Certification" ;
        sh:order 3 ;
    ] ;

    # Data Properties - Notes and Metadata
    sh:property [
        sh:path dyn:hasDescription ;
        sh:datatype xsd:string ;
        sh:maxCount 1 ;
        sh:name "Description" ;
        sh:description "Additional description or notes about the material" ;
        sh:group "Notes" ;
        sh:order 1 ;
    ] ;

    sh:property [
        sh:path dyn:hasSpecialNotes ;
        sh:datatype xsd:string ;
        sh:maxCount 1 ;
        sh:name "Special Notes" ;
        sh:description "Special considerations or observations about the material" ;
        sh:group "Notes" ;
        sh:order 2 ;
    ] .

#################################################################
#    Validation Rules and Constraints
#################################################################

# Ensure at least one identification property is provided
dyn:MaterialIdentificationConstraint a sh:NodeShape ;
    sh:targetClass dyn:Material ;
    sh:or (
        [ sh:property [ sh:path dyn:hasMaterialName ; sh:minCount 1 ] ]
        [ sh:property [ sh:path dyn:hasMaterialCode ; sh:minCount 1 ] ]
        [ sh:property [ sh:path dyn:hasAlloyDesignation ; sh:minCount 1 ] ]
    ) ;
    sh:message "At least one identification property (Material Name, Material Code, or Alloy Designation) must be specified" .

# Ensure receipt date is not in the future
dyn:ReceiptDateConstraint a sh:NodeShape ;
    sh:targetClass dyn:Material ;
    sh:if [
        sh:property [ sh:path dyn:hasReceiptDate ; sh:minCount 1 ]
    ] ;
    sh:then [
        sh:sparql [
            a sh:SPARQLConstraint ;
            sh:message "Receipt date cannot be in the future" ;
            sh:prefixes [
                sh:declare [
                    sh:prefix "dyn" ;
                    sh:namespace "https://dynamat.utep.edu/ontology#" ;
                ]
            ] ;
            sh:select """
                SELECT ?this WHERE {
                    ?this dyn:hasReceiptDate ?date .
                    FILTER(?date > NOW())
                }
            """ ;
        ]
    ] .

# Ensure certificate number is provided when certification level is specified
dyn:CertificationConstraint a sh:NodeShape ;
    sh:targetClass dyn:Material ;
    sh:if [
        sh:property [
            sh:path dyn:hasCertificationLevel ;
            sh:hasValue "Mill Test Certificate" ;
        ]
    ] ;
    sh:then [
        sh:property [
            sh:path dyn:hasCertificateNumber ;
            sh:minCount 1 ;
        ]
    ] ;
    sh:message "Certificate number must be provided when certification level is 'Mill Test Certificate'" .

# Ensure primary phase is also listed in general phases
dyn:PrimaryPhaseConstraint a sh:NodeShape ;
    sh:targetClass dyn:Material ;
    sh:if [
        sh:property [ sh:path dyn:hasPrimaryPhase ; sh:minCount 1 ]
    ] ;
    sh:then [
        sh:sparql [
            a sh:SPARQLConstraint ;
            sh:message "Primary phase must also be listed in the general phases" ;
            sh:prefixes [
                sh:declare [
                    sh:prefix "dyn" ;
                    sh:namespace "https://dynamat.utep.edu/ontology#" ;
                ]
            ] ;
            sh:select """
                SELECT ?this WHERE {
                    ?this dyn:hasPrimaryPhase ?primary .
                    FILTER NOT EXISTS { ?this dyn:hasPhase ?primary }
                }
            """ ;
        ]
    ] .
