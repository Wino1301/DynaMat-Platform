@prefix dyn: <https://dynamat.utep.edu/ontology#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix qudt: <http://qudt.org/schema/qudt/> .
@prefix unit: <http://qudt.org/vocab/unit/> .
@prefix qkdv: <http://qudt.org/vocab/quantitykind/> .

# =============================================================================
# DynaMat Platform - SHPB Compression SHACL Shapes
# =============================================================================
#
# SHPB-specific validation shapes split from mechanical_testing_shapes.ttl.
# Covers:
# 1. SHPBCompression (equipment, test conditions, processing links)
# 2. PulseDetectionParams (detection configuration per pulse)
# 3. AlignmentParams (alignment configuration and results)
# 4. EquilibriumMetrics (force equilibrium assessment)
# 5. SegmentationParams (segment extraction parameters)
# 6. Tukey parameters (signal tapering - directly on SHPBCompression)
# 7. Business rules (pulse shaper, lubrication, dimensions)
# =============================================================================


#################################################################
#    SHPBCompression Shape (SHPB-specific properties)
#################################################################

dyn:SHPBCompressionShape a sh:NodeShape ;
    sh:targetClass dyn:SHPBCompression ;
    rdfs:comment "Validation rules for SHPB compression test instances" ;

    # =========================================================================
    # REQUIRED FIELDS — Inherited from MechanicalTest
    # (Duplicated here so validation works on partial graphs without
    #  needing the full OWL class hierarchy for RDFS inference.)
    #
    # NOTE: performedOn and hasUser use sh:nodeKind sh:IRI instead of
    # sh:class because their targets (Specimen, User) are validated in
    # their own contexts.  Using sh:class here would require adding
    # rdf:type triples to the partial graph, which triggers SpecimenShape
    # and UserShape on incomplete data.
    # =========================================================================

    sh:property [
        sh:path dyn:hasTestID ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "Test ID is required" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:performedOn ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:message "Test must be performed on a specimen" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasTestDate ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:datatype xsd:date ;
        sh:message "Test date is required" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasUser ;
        sh:nodeKind sh:IRI ;
        sh:minCount 1 ;
        sh:message "An operator must be assigned to the test" ;
        sh:severity sh:Violation ;
    ] ;

    # =========================================================================
    # REQUIRED FIELDS — SHPB-specific (Critical for calculations)
    # =========================================================================

    sh:property [
        sh:path dyn:hasIncidentBar ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:class dyn:IncidentBar ;
        sh:message "Incident bar must be selected" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasTransmissionBar ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:class dyn:TransmissionBar ;
        sh:message "Transmission bar must be selected" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasStrikerBar ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:class dyn:StrikerBar ;
        sh:message "Striker bar must be selected" ;
        sh:severity sh:Violation ;
    ] ;

    # =========================================================================
    # WARNINGS (Important for downstream operations — allow continue)
    # =========================================================================

    sh:property [
        sh:path dyn:hasIncidentStrainGauge ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:class dyn:StrainGauge ;
        sh:message "Incident strain gauge should be selected (needed for voltage-to-strain conversion)" ;
        sh:severity sh:Warning ;
    ] ;

    sh:property [
        sh:path dyn:hasTransmissionStrainGauge ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:class dyn:StrainGauge ;
        sh:message "Transmission strain gauge should be selected (needed for voltage-to-strain conversion)" ;
        sh:severity sh:Warning ;
    ] ;

    sh:property [
        sh:path dyn:hasStrikerVelocity ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:node dyn:QuantityValueShape ;
        sh:message "Striker velocity is required (needed for strain rate characterization)" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasTestType ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:class dyn:TestType ;
        sh:message "Test type should be specified (calibration, elastic, or specimen test)" ;
        sh:severity sh:Warning ;
    ] ;

    # =========================================================================
    # INFO (Recommended but not critical — allow continue)
    # =========================================================================

    sh:property [
        sh:path dyn:hasPulseShaper ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:class dyn:PulseShaper ;
        sh:message "Consider specifying pulse shaper for complete test documentation" ;
        sh:severity sh:Info ;
    ] ;

    sh:property [
        sh:path dyn:hasMomentumTrap ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:class dyn:MomentumTrap ;
        sh:message "Consider specifying momentum trap configuration for complete test documentation" ;
        sh:severity sh:Info ;
    ] ;

    # =========================================================================
    # CARDINALITY CONSTRAINTS (Single-value properties)
    # =========================================================================

    # Test conditions
    sh:property [ sh:path dyn:hasStrikerLength ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasIncidentBarLength ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasTransmissionBarLength ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasBarrelOffset ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasIncidentStrainGaugeDistance ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasTransmissionStrainGaugeDistance ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasLubrication ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ;
    sh:property [ sh:path dyn:hasMomentumTrapTailoredDistance ; sh:maxCount 1 ] ;

    # Pulse shaping
    sh:property [ sh:path dyn:hasPulseShaping ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ;
    sh:property [ sh:path dyn:hasPulseShaperDiameter ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasPulseShaperThickness ; sh:maxCount 1 ; sh:datatype xsd:double ] ;

    # Pulse characteristics (calculated from equipment — Warning severity)
    sh:property [
        sh:path dyn:hasPulseDuration ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:node dyn:QuantityValueShape ;
        sh:message "Pulse duration should be calculated (2L/C) from striker geometry" ;
        sh:severity sh:Warning ;
    ] ;
    sh:property [
        sh:path dyn:hasPulseLength ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:node dyn:QuantityValueShape ;
        sh:message "Pulse length should be calculated (2L) from striker geometry" ;
        sh:severity sh:Warning ;
    ] ;
    sh:property [
        sh:path dyn:hasPulseStrainAmplitude ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:node dyn:QuantityValueShape ;
        sh:message "Pulse strain amplitude should be calculated (V/2C)" ;
        sh:severity sh:Warning ;
    ] ;
    sh:property [
        sh:path dyn:hasPulseStressAmplitude ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:node dyn:QuantityValueShape ;
        sh:message "Pulse stress amplitude should be calculated (rhoCV/2)" ;
        sh:severity sh:Warning ;
    ] ;
    sh:property [ sh:path dyn:hasPulseSpeed ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasPulseRiseTime ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasPulsePoints ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;

    # Processing parameters (sub-instance links)
    sh:property [ sh:path dyn:hasAlignmentParams ; sh:maxCount 1 ; sh:class dyn:AlignmentParams ] ;
    sh:property [ sh:path dyn:hasEquilibriumMetrics ; sh:maxCount 1 ; sh:class dyn:EquilibriumMetrics ] ;
    sh:property [ sh:path dyn:hasSegmentationParams ; sh:maxCount 1 ; sh:class dyn:SegmentationParams ] ;
    sh:property [ sh:path dyn:hasPulseDetectionParams ; sh:class dyn:PulseDetectionParams ] ;

    # Analysis metadata
    sh:property [ sh:path dyn:hasAnalysisTimestamp ; sh:maxCount 1 ; sh:datatype xsd:dateTime ] ;
    sh:property [ sh:path dyn:hasCenteredSegmentPoints ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasSamplingInterval ; sh:maxCount 1 ] ;
    sh:property [ sh:path dyn:hasTukeyAlphaParam ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasShiftValue ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasSelectionMetric ; sh:maxCount 1 ; sh:class dyn:DetectionMetric ] ;
    sh:property [ sh:path dyn:hasKLinear ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasKTrials ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
    sh:property [ sh:path dyn:hasMinSeparation ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasFrontIndex ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasDetectionLowerBound ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasDetectionUpperBound ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasDetectionPolarity ; sh:maxCount 1 ; sh:class dyn:PolarityType ] ;

    # Equilibrium metrics (stored at test level)
    sh:property [ sh:path dyn:hasDSUF ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasFBC ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasSEQI ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasSOI ; sh:maxCount 1 ; sh:datatype xsd:double ] ;

    # Qualitative assessment
    sh:property [ sh:path dyn:hasWaveDispersion ; sh:maxCount 1 ; sh:datatype xsd:string ] .


#################################################################
#    PulseDetectionParams Shape (Pulse detection configuration)
#################################################################

dyn:PulseDetectionParamsShape a sh:NodeShape ;
    sh:targetClass dyn:PulseDetectionParams ;
    rdfs:comment "Validation rules for pulse detection parameter instances" ;

    # =========================================================================
    # REQUIRED FIELDS
    # =========================================================================

    sh:property [
        sh:path dyn:appliedToSeries ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class dyn:DataSeries ;
        sh:message "Pulse detection params must reference the data series they were applied to" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasPulsePoints ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:minExclusive 0 ;
        sh:message "Pulse points (expected pulse duration in samples) is required" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasStartIndex ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:message "Start index of detected window is required" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasEndIndex ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:message "End index of detected window is required" ;
        sh:severity sh:Violation ;
    ] ;

    sh:property [
        sh:path dyn:hasWindowLength ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:minExclusive 0 ;
        sh:message "Window length is required" ;
        sh:severity sh:Violation ;
    ] ;

    # =========================================================================
    # WARNINGS (Important configuration — should be present)
    # =========================================================================

    sh:property [
        sh:path dyn:hasDetectionPolarity ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:class dyn:PolarityType ;
        sh:message "Detection polarity should be specified (compressive or tensile)" ;
        sh:severity sh:Warning ;
    ] ;

    sh:property [
        sh:path dyn:hasKTrials ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "K trials thresholds should be specified for reproducibility" ;
        sh:severity sh:Warning ;
    ] ;

    sh:property [
        sh:path dyn:hasMinSeparation ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:message "Minimum separation between peaks should be specified" ;
        sh:severity sh:Warning ;
    ] ;

    sh:property [
        sh:path dyn:hasSelectionMetric ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:class dyn:DetectionMetric ;
        sh:message "Selection metric should be specified (median or peak)" ;
        sh:severity sh:Warning ;
    ] ;

    # =========================================================================
    # CARDINALITY CONSTRAINTS
    # =========================================================================

    sh:property [ sh:path dyn:hasDetectionLowerBound ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasDetectionUpperBound ; sh:maxCount 1 ; sh:datatype xsd:integer ] .


#################################################################
#    AlignmentParams Shape (Pulse alignment configuration)
#################################################################

dyn:AlignmentParamsShape a sh:NodeShape ;
    sh:targetClass dyn:AlignmentParams ;
    rdfs:comment "Validation rules for alignment parameter instances" ;

    # =========================================================================
    # CARDINALITY CONSTRAINTS
    # =========================================================================

    sh:property [ sh:path dyn:hasKLinear ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasReflectedSearchMin ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasReflectedSearchMax ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasTransmittedSearchMin ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasTransmittedSearchMax ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasCorrelationWeight ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDisplacementWeight ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasStrainRateWeight ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasStrainWeight ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasReflectedShiftValue ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasTransmittedShiftValue ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasFrontThreshold ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasFrontIndex ; sh:maxCount 1 ; sh:datatype xsd:integer ] ;
    sh:property [ sh:path dyn:hasCenteredSegmentPoints ; sh:maxCount 1 ; sh:datatype xsd:integer ] .


#################################################################
#    EquilibriumMetrics Shape (Force equilibrium assessment)
#################################################################

dyn:EquilibriumMetricsShape a sh:NodeShape ;
    sh:targetClass dyn:EquilibriumMetrics ;
    rdfs:comment "Validation rules for equilibrium metrics instances" ;

    # =========================================================================
    # CARDINALITY CONSTRAINTS
    # =========================================================================

    sh:property [ sh:path dyn:hasDSUF ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDSUFLoading ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDSUFPlateau ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasDSUFUnloading ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasFBC ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasFBCLoading ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasFBCPlateau ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasFBCUnloading ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasSEQI ; sh:maxCount 1 ; sh:datatype xsd:double ] ;
    sh:property [ sh:path dyn:hasSOI ; sh:maxCount 1 ; sh:datatype xsd:double ] .


#################################################################
#    SegmentationParams Shape (Pulse segmentation parameters)
#################################################################

dyn:SegmentationParamsShape a sh:NodeShape ;
    sh:targetClass dyn:SegmentationParams ;
    rdfs:comment "Validation rules for segmentation parameter instances" ;
    sh:property [
        sh:path dyn:hasSegmentPoints ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:minExclusive 0 ;
        sh:message "Segment points must be specified and positive" ;
        sh:severity sh:Violation ;
    ] ;
    sh:property [
        sh:path dyn:hasSegmentThreshold ;
        sh:minCount 1 ; sh:maxCount 1 ;
        sh:datatype xsd:double ;
        sh:minExclusive 0.0 ;
        sh:maxExclusive 1.0 ;
        sh:message "Segment threshold must be between 0 and 1 (exclusive)" ;
        sh:severity sh:Violation ;
    ] .



#################################################################
#    Business Rules - SHPB-Specific Constraints
#################################################################

# -----------------------------------------------------------------------------
# Pulse Shaper Constraint (Required when pulse shaping is used)
# -----------------------------------------------------------------------------
dyn:PulseShaperConstraint a sh:NodeShape ;
    sh:targetClass dyn:SHPBCompression ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Pulse shaper must be specified when pulse shaping is used" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasPulseShaping true .
                FILTER NOT EXISTS { ?this dyn:hasPulseShaper ?shaper }
            }
        """ ;
    ] .


# -----------------------------------------------------------------------------
# Pulse Shaper Dimension Constraint (Thickness < Diameter)
# -----------------------------------------------------------------------------
dyn:PulseShaperDimensionConstraint a sh:NodeShape ;
    sh:targetClass dyn:SHPBCompression ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Pulse shaper thickness must be less than diameter" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasPulseShaperDiameter ?diameter .
                ?this dyn:hasPulseShaperThickness ?thickness .
                FILTER(?thickness >= ?diameter)
            }
        """ ;
    ] .


# -----------------------------------------------------------------------------
# Momentum Trap Distance Constraint (Required when tailored gap trap is used)
# -----------------------------------------------------------------------------
dyn:MomentumTrapDistanceConstraint a sh:NodeShape ;
    sh:targetClass dyn:SHPBCompression ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Momentum trap tailored distance must be specified and positive when using a Tailored Gap momentum trap" ;
        sh:prefixes [
            sh:declare [
                sh:prefix "dyn" ;
                sh:namespace "https://dynamat.utep.edu/ontology#"^^xsd:anyURI ;
            ] ;
            sh:declare [
                sh:prefix "qudt" ;
                sh:namespace "http://qudt.org/schema/qudt/"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT ?this WHERE {
                ?this dyn:hasMomentumTrap dyn:MomentumTrap_TailoredGap .
                OPTIONAL {
                    ?this dyn:hasMomentumTrapTailoredDistance ?distBN .
                    ?distBN qudt:numericValue ?distVal .
                }
                FILTER(!BOUND(?distVal) || ?distVal <= 0.0)
            }
        """ ;
    ] .


###  Generated for DynaMat Platform SHPB compression validation
